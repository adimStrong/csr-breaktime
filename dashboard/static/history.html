<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - CSR Breaktime Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .card { background: rgba(255,255,255,0.95); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-history text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">Historical Data</h1>
                    <p class="text-xs text-blue-200">CSR Breaktime</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="/" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition">
                    <i class="fas fa-tachometer-alt mr-2"></i>Live Dashboard
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Filters Card -->
        <div class="card rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-blue-500"></i>Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Agent</label>
                    <select id="userFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">All Agents</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Break Type</label>
                    <select id="breakTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">All Types</option>
                        <option value="B">‚òï Break</option>
                        <option value="W">üöª WC</option>
                        <option value="P">üöΩ WCP</option>
                        <option value="O">‚ö†Ô∏è Other</option>
                        <option value="G">üçΩÔ∏è Get Food</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="applyFilters()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                        <i class="fas fa-search mr-1"></i> Search
                    </button>
                    <button onclick="exportFiltered()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card rounded-xl p-4 shadow-lg">
                <p class="text-sm text-gray-500">Total Records</p>
                <p id="totalRecords" class="text-2xl font-bold text-gray-800">-</p>
            </div>
            <div class="card rounded-xl p-4 shadow-lg">
                <p class="text-sm text-gray-500">Total Duration</p>
                <p id="totalDuration" class="text-2xl font-bold text-gray-800">-</p>
            </div>
            <div class="card rounded-xl p-4 shadow-lg">
                <p class="text-sm text-gray-500">Unique Agents</p>
                <p id="uniqueAgents" class="text-2xl font-bold text-gray-800">-</p>
            </div>
            <div class="card rounded-xl p-4 shadow-lg">
                <p class="text-sm text-gray-500">Avg Duration</p>
                <p id="avgDuration" class="text-2xl font-bold text-gray-800">-</p>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="px-4 py-3 bg-gradient-to-r from-gray-700 to-gray-800 flex items-center justify-between">
                <h2 class="font-semibold text-white"><i class="fas fa-table mr-2"></i>Break Logs</h2>
                <span id="resultCount" class="text-sm text-gray-300">0 results</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Timestamp</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Agent</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Break Type</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Action</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Duration</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Reason</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Select filters and click Search</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div class="px-4 py-3 bg-gray-50 flex items-center justify-between">
                <div class="text-sm text-gray-500">
                    Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="showingTotal">0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="prevPage()" id="prevBtn" disabled class="px-3 py-1 bg-gray-200 text-gray-600 rounded disabled:opacity-50">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <button onclick="nextPage()" id="nextBtn" disabled class="px-3 py-1 bg-gray-200 text-gray-600 rounded disabled:opacity-50">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Daily Summary Chart -->
        <div class="card rounded-xl shadow-lg overflow-hidden">
            <div class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-indigo-600">
                <h2 class="font-semibold text-white"><i class="fas fa-chart-bar mr-2"></i>Daily Summary</h2>
            </div>
            <div class="p-4">
                <canvas id="dailyChart" height="100"></canvas>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let currentPage = 0;
        let pageSize = 50;
        let totalRecords = 0;
        let dailyChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates (last 7 days)
            const today = new Date();
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];

            loadUsers();
            initChart();
            applyFilters();
        });

        async function loadUsers() {
            try {
                const r = await fetch(`${API_BASE}/api/users?active_only=false`);
                const data = await r.json();
                const select = document.getElementById('userFilter');
                data.users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = u.full_name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function initChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Break Count',
                        data: [],
                        backgroundColor: '#6366f1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        async function applyFilters() {
            currentPage = 0;
            await loadLogs();
            await loadDailySummary();
        }

        async function loadLogs() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const userId = document.getElementById('userFilter').value;
            const breakType = document.getElementById('breakTypeFilter').value;

            if (!start || !end) {
                alert('Please select date range');
                return;
            }

            let url = `${API_BASE}/api/history/logs?start=${start}&end=${end}&limit=${pageSize}&offset=${currentPage * pageSize}`;
            if (userId) url += `&user_id=${userId}`;
            if (breakType) url += `&break_type=${breakType}`;

            try {
                const r = await fetch(url);
                const data = await r.json();

                totalRecords = data.total;
                renderTable(data.logs);
                updatePagination(data);
                updateSummary(data.logs);

            } catch (e) {
                console.error('Failed to load logs:', e);
            }
        }

        function renderTable(logs) {
            const tbody = document.getElementById('logsTable');

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No records found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const actionClass = log.action === 'OUT' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700';
                const duration = log.duration_minutes ? `${log.duration_minutes.toFixed(1)} min` : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-600">${formatTimestamp(log.timestamp)}</td>
                        <td class="px-4 py-3 font-medium text-gray-800">${log.full_name}</td>
                        <td class="px-4 py-3 text-center">${log.break_type}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${actionClass}">${log.action}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-gray-600">${duration}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${log.reason || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination(data) {
            const from = data.offset + 1;
            const to = Math.min(data.offset + data.logs.length, data.total);

            document.getElementById('showingFrom').textContent = data.total > 0 ? from : 0;
            document.getElementById('showingTo').textContent = to;
            document.getElementById('showingTotal').textContent = data.total;
            document.getElementById('resultCount').textContent = `${data.total} results`;

            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = to >= data.total;
        }

        function updateSummary(logs) {
            const backLogs = logs.filter(l => l.action === 'BACK' && l.duration_minutes);
            const totalDur = backLogs.reduce((sum, l) => sum + l.duration_minutes, 0);
            const uniqueAgents = new Set(logs.map(l => l.full_name)).size;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalDuration').textContent = formatDuration(totalDur);
            document.getElementById('uniqueAgents').textContent = uniqueAgents;
            document.getElementById('avgDuration').textContent = backLogs.length > 0
                ? `${(totalDur / backLogs.length).toFixed(1)}m` : '-';
        }

        async function loadDailySummary() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            try {
                const r = await fetch(`${API_BASE}/api/compliance/trend?days=30`);
                const data = await r.json();

                // Filter to date range
                const filtered = data.trend.filter(t => t.date >= start && t.date <= end);

                dailyChart.data.labels = filtered.map(t => {
                    const d = new Date(t.date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                dailyChart.data.datasets[0].data = filtered.map(t => t.total_breaks);
                dailyChart.update();

            } catch (e) {
                console.error('Failed to load daily summary:', e);
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadLogs();
            }
        }

        function nextPage() {
            if ((currentPage + 1) * pageSize < totalRecords) {
                currentPage++;
                loadLogs();
            }
        }

        function exportFiltered() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const userId = document.getElementById('userFilter').value;

            let url = `${API_BASE}/api/export/csv?start=${start}&end=${end}`;
            if (userId) url += `&user_id=${userId}`;

            window.open(url, '_blank');
        }

        function formatTimestamp(ts) {
            const d = new Date(ts);
            return d.toLocaleString('en-US', {
                month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes.toFixed(0)}m`;
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h ${mins}m`;
        }
    </script>
</body>
</html>
